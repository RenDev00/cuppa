name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          script: |-
            set -e 

            cd /var/www/cuppa/
            git fetch --all
            git reset --hard origin/main

            npm install --no-audit --no-fund
            npm run build
            npm prune --production
            pm2 restart cuppa

            echo "Waiting for backend..."
            for i in {1..20}; do
              if curl -s -f -o /dev/null http://localhost:3000; then
                echo "Backend ready after $i attempts"
                exit 0
              fi
              sleep 3
            done

            echo "ERROR: Backend not responding after 60s"
            exit 1

      - name: Build commit summary
        id: summary
        if: always()
        run: |
          # ────────────────────────────────────────────────
          # Prepare basic info
          # ────────────────────────────────────────────────
          HEAD_MSG="${{ github.event.head_commit.message }}"
          HEAD_SHA="${{ github.sha }}"
          HEAD_SHORT="${HEAD_SHA:0:9}"
          HEAD_AUTHOR="${{ github.event.head_commit.author.name }}"

          # Escape for Markdown (basic escaping - Telegram MarkdownV2 needs more, but we use simple Markdown)
          HEAD_MSG_SAFE=$(echo "$HEAD_MSG" | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g' | head -n 1)

          SUMMARY="*Deploy to VPS* — ${{ job.status == 'success' && '✅ Success' || job.status == 'failure' && '❌ Failed' || '⚪ Cancelled' }}\n\n"

          # ────────────────────────────────────────────────
          # Check if this looks like a merge commit
          # ────────────────────────────────────────────────
          IS_MERGE=false
          PR_NUMBER=""
          if echo "$HEAD_MSG" | grep -iqE "^Merge pull request #[0-9]+"; then
            IS_MERGE=true
            PR_NUMBER=$(echo "$HEAD_MSG" | grep -oE '#[0-9]+' | head -1 | tr -d '#')
          fi

          if [ "$IS_MERGE" = true ] && [ -n "$PR_NUMBER" ]; then
            # Try to get commits from the merged PR
            echo "Fetching commits from merged PR #$PR_NUMBER..."
            RESPONSE=$(curl -s -L -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/commits")

            if echo "$RESPONSE" | grep -q '"message":'; then
              # API error → fallback
              SUMMARY="${SUMMARY}*Merged PR #$PR_NUMBER*\n(commits fetch failed)\n"
              SUMMARY="${SUMMARY}Merge commit: ${HEAD_SHORT} — ${HEAD_MSG_SAFE}\n"
            else
              # Parse commits with jq (available on ubuntu-latest runner)
              COMMIT_LIST=$(echo "$RESPONSE" | jq -r '.[] | "• \(.commit.message | split("\n")[0] | .[0:80]) (\(.sha | .[0:9]))"')
              
              if [ -z "$COMMIT_LIST" ]; then
                SUMMARY="${SUMMARY}*Merged PR #$PR_NUMBER* (no commits found)\n"
              else
                SUMMARY="${SUMMARY}*Merged PR #$PR_NUMBER*\n"
                SUMMARY="${SUMMARY}${COMMIT_LIST}\n"
              fi
            fi
          else
            # Not a detected merge → show pushed commit(s)
            if [ ${#github.event.commits[@]} -gt 1 ]; then
              # Multiple commits pushed at once
              SUMMARY="${SUMMARY}*Multiple commits pushed*\n"
              for commit in $(jq -c '.[]' <<< '${{ toJSON(github.event.commits) }}'); do
                SHA=$(echo "$commit" | jq -r '.id' | cut -c1-9)
                MSG=$(echo "$commit" | jq -r '.message' | head -n1 | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g')
                SUMMARY="${SUMMARY}• ${MSG} (${SHA})\n"
              done
            else
              # Single commit (most common case)
              SUMMARY="${SUMMARY}*Commit*: ${HEAD_SHORT} — ${HEAD_MSG_SAFE}\n"
              if [ -n "$HEAD_AUTHOR" ]; then
                SUMMARY="${SUMMARY}Author: ${HEAD_AUTHOR}\n"
              fi
            fi
          fi

          # Common footer
          SUMMARY="${SUMMARY}\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\n"
          SUMMARY="${SUMMARY}Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Output for Telegram step
          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Telegram on completion
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: ${{ steps.summary.outputs.text }}
          disable_notification: false
