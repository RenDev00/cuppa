name: Deploy to VPS

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed folders
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            public: 'public/**'
            server: 'server/**'

      - name: Deploy over SSH
        if: steps.filter.outputs.public == 'true' || steps.filter.outputs.server == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          script: |-
            set -e 

            cd /var/www/cuppa/
            git fetch --all
            git reset --hard origin/main

            npm install --no-audit --no-fund
            npm run build
            npm prune --production
            pm2 restart cuppa

            echo "Waiting for backend..."
            for i in {1..20}; do
              if curl -s -f -o /dev/null http://localhost:3000; then
                echo "Backend ready after $i attempts"
                exit 0
              fi
              sleep 3
            done

            echo "ERROR: Backend not responding after 60s"
            exit 1

      - name: Get merged PR number (if merge commit)
        id: get_pr
        if: ${{ always() && startsWith(github.event.head_commit.message, 'Merge pull request') }}
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha
            });
            const pr = result.data[0];
            if (pr) {
              return {
                number: pr.number,
                title: pr.title
              };
            } else {
              return null;
            }
          result-encoding: json

      - name: Build commit summary for Telegram
        id: summary
        if: always()
        run: |
          SUMMARY="*Deploy to VPS* — ${{ job.status == 'success' && '✅ Success' || job.status == 'failure' && '❌ Failed' || '⚪ Cancelled' }}\n\n"

          PR_DATA='${{ steps.get_pr.outputs.result }}'

          if [ -n "$PR_DATA" ] && [ "$PR_DATA" != "null" ]; then
            # Merged PR case
            PR_NUM=$(echo "$PR_DATA" | jq -r '.number')
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
            PR_TITLE_SAFE=$(echo "$PR_TITLE" | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g' | head -n1)

            # Fetch commits from the PR
            RESPONSE=$(curl -s -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM/commits")

            if echo "$RESPONSE" | jq -e 'type == "array"' >/dev/null 2>&1; then
              COMMIT_LIST=$(echo "$RESPONSE" | jq -r '.[] | "• \(.commit.message | split("\n")[0] | .[0:100]) (\(.sha | .[0:9]))"' 2>/dev/null || echo "")
              if [ -z "$COMMIT_LIST" ]; then
                SUMMARY="${SUMMARY}*Merged PR #$PR_NUM* - $PR_TITLE_SAFE\n(no commits listed)\n"
              else
                SUMMARY="${SUMMARY}*Merged PR #$PR_NUM* - $PR_TITLE_SAFE\n${COMMIT_LIST}\n"
              fi
            else
              SUMMARY="${SUMMARY}*Merged PR #$PR_NUM* - $PR_TITLE_SAFE\n(Could not fetch commits - API error)\n"
              SUMMARY="${SUMMARY}Merge commit: ${{ github.sha }}\n"
            fi

          else
            # Non-merge case (direct push to main, possibly multiple commits)
            COMMITS_JSON='${{ toJSON(github.event.commits) }}'
            NUM_COMMITS=$(echo "$COMMITS_JSON" | jq 'length' 2>/dev/null || echo 0)

            HEAD_MSG="${{ github.event.head_commit.message }}"
            HEAD_SHORT=$(echo "${{ github.sha }}" | cut -c1-9)
            HEAD_AUTHOR="${{ github.event.head_commit.author.name }}"
            HEAD_MSG_SAFE=$(echo "$HEAD_MSG" | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g' | head -n1)

            if [ "$NUM_COMMITS" -gt 1 ]; then
              SUMMARY="${SUMMARY}*Multiple commits pushed*\n"
              for commit in $(echo "$COMMITS_JSON" | jq -c '.[]'); do
                SHA=$(echo "$commit" | jq -r '.id' | cut -c1-9)
                MSG=$(echo "$commit" | jq -r '.message' | head -n1 | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g')
                SUMMARY="${SUMMARY}• ${MSG} (${SHA})\n"
              done
            else
              SUMMARY="${SUMMARY}*Commit*: ${HEAD_SHORT} — ${HEAD_MSG_SAFE}\n"
              [ -n "$HEAD_AUTHOR" ] && SUMMARY="${SUMMARY}Author: ${HEAD_AUTHOR}\n"
            fi
          fi

          SUMMARY="${SUMMARY}\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\n"
          SUMMARY="${SUMMARY}Run → https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Telegram on completion
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: ${{ steps.summary.outputs.text }}
          disable_notification: false
