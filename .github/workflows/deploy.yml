name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed folders
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            public: 'public/**'
            server: 'server/**'

      - name: Deploy over SSH
        if: steps.filter.outputs.public == 'true' || steps.filter.outputs.server == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT || '22' }}
          script: |-
            set -e 

            cd /var/www/cuppa/
            git fetch --all
            git reset --hard origin/main

            npm install --no-audit --no-fund
            npm run build
            npm prune --production
            pm2 restart cuppa

            echo "Waiting for backend..."
            for i in {1..20}; do
              if curl -s -f -o /dev/null http://localhost:3000; then
                echo "Backend ready after $i attempts"
                exit 0
              fi
              sleep 3
            done

            echo "ERROR: Backend not responding after 60s"
            exit 1

      - name: Get merged PR info (if this push is a merge commit)
        id: get_pr
        if: always()
        uses: actions-ecosystem/action-get-merged-pull-request@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build commit summary for Telegram
        id: summary
        if: always()
        run: |
          # Start with status header
          SUMMARY="*Deploy to VPS* — ${{ job.status == 'success' && '✅ Success' || job.status == 'failure' && '❌ Failed' || '⚪ Cancelled' }}\n\n"

          # ────────────────────────────────────────────────
          # If we detected a merged PR
          # ────────────────────────────────────────────────
          if [ -n "${{ steps.get_pr.outputs.number }}" ]; then
            PR_NUM="${{ steps.get_pr.outputs.number }}"
            PR_TITLE="${{ steps.get_pr.outputs.title }}"

            # Try to fetch the list of commits from this PR
            RESPONSE=$(curl -s -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUM/commits")

            if echo "$RESPONSE" | grep -q '"message"'; then
              # API failed → fallback to basic merge info
              SUMMARY="${SUMMARY}*Merged PR #$PR_NUM*\n"
              SUMMARY="${SUMMARY}Title: $PR_TITLE\n"
              SUMMARY="${SUMMARY}(Could not fetch individual commits)\n"
              SUMMARY="${SUMMARY}Merge commit: ${{ github.sha }}\n"
            else
              # Parse commits (limit message to ~100 chars, short SHA)
              COMMIT_LIST=$(echo "$RESPONSE" | jq -r '.[] | "• \(.commit.message | split("\n")[0] | .[0:100]) (\(.sha | .[0:9]))"')

              if [ -z "$COMMIT_LIST" ]; then
                SUMMARY="${SUMMARY}*Merged PR #$PR_NUM* – $PR_TITLE\n(no commits listed)\n"
              else
                SUMMARY="${SUMMARY}*Merged PR #$PR_NUM* – $PR_TITLE\n"
                SUMMARY="${SUMMARY}${COMMIT_LIST}\n"
              fi
            fi

          # ────────────────────────────────────────────────
          # Not a merge (direct push or multiple commits)
          # ────────────────────────────────────────────────
          else
            HEAD_MSG="${{ github.event.head_commit.message }}"
            HEAD_SHORT="${{ github.sha }}"
            HEAD_SHORT="${HEAD_SHORT:0:9}"
            HEAD_AUTHOR="${{ github.event.head_commit.author.name }}"

            # Escape special chars for Telegram Markdown
            HEAD_MSG_SAFE=$(echo "$HEAD_MSG" | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g' | head -n1)

            if [ ${#github.event.commits[@]} -gt 1 ]; then
              SUMMARY="${SUMMARY}*Multiple commits pushed*\n"
              for commit in $(jq -c '.[]' <<< '${{ toJSON(github.event.commits) }}'); do
                SHA=$(echo "$commit" | jq -r '.id' | cut -c1-9)
                MSG=$(echo "$commit" | jq -r '.message' | head -n1 | sed 's/[_*[\]()~`>#+=|{}.!-]/\\&/g')
                SUMMARY="${SUMMARY}• ${MSG} (${SHA})\n"
              done
            else
              SUMMARY="${SUMMARY}*Commit*: ${HEAD_SHORT} — ${HEAD_MSG_SAFE}\n"
              if [ -n "$HEAD_AUTHOR" ]; then
                SUMMARY="${SUMMARY}Author: ${HEAD_AUTHOR}\n"
              fi
            fi
          fi

          # Common footer
          SUMMARY="${SUMMARY}\nRepo: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\n"
          SUMMARY="${SUMMARY}Run → https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Output multiline
          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Notify Telegram on completion
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: ${{ steps.summary.outputs.text }}
          disable_notification: false
